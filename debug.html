<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°</h1>
    
    <div class="debug-section">
        <h2>ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testSupabaseConnection()">Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testReservationTable()">äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</button>
        <button onclick="createTestReservation()">ãƒ†ã‚¹ãƒˆäºˆç´„ä½œæˆ</button>
        <button onclick="listAllReservations()">å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</button>
        <button onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>

    <div id="debugOutput"></div>

    <!-- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="config/env.js"></script>
    <script src="config/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

    <script>
        let supabaseClient;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const supabaseConfig = window.AppConfig.getSupabaseConfig();
                supabaseClient = supabase.createClient(supabaseConfig.url, supabaseConfig.key);
                
                addOutput('åˆæœŸåŒ–', 'âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆå®Œäº†', 'success');
                addOutput('è¨­å®š', JSON.stringify(supabaseConfig, null, 2), 'info');
            } catch (error) {
                addOutput('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', error.message, 'error');
            }
        });

        function addOutput(title, content, type = 'info') {
            const output = document.getElementById('debugOutput');
            const section = document.createElement('div');
            section.className = `debug-section ${type}`;
            section.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
                <small>æ™‚åˆ»: ${new Date().toLocaleTimeString()}</small>
            `;
            output.appendChild(section);
            section.scrollIntoView({ behavior: 'smooth' });
        }

        async function testSupabaseConnection() {
            try {
                addOutput('æ¥ç¶šãƒ†ã‚¹ãƒˆ', 'æ¥ç¶šç¢ºèªä¸­...', 'info');
                
                // åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                addOutput('æ¥ç¶šãƒ†ã‚¹ãƒˆ', 'âœ… Supabaseæ¥ç¶šæˆåŠŸï¼', 'success');
                addOutput('ãƒ‡ãƒ¼ã‚¿', `äºˆç´„ä»¶æ•°: ${data?.length || 0}ä»¶`, 'info');
                
            } catch (error) {
                addOutput('æ¥ç¶šã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`, 'error');
                console.error('Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function testReservationTable() {
            try {
                addOutput('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ã‚¹ãƒˆ', 'reservationsãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªä¸­...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                addOutput('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ã‚¹ãƒˆ', 'âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');
                addOutput('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿', data, 'info');
                
            } catch (error) {
                addOutput('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`, 'error');
            }
        }

        async function createTestReservation() {
            try {
                const testData = {
                    name: 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ',
                    phone: '090-0000-0000',
                    datetime: '2025-12-10T14:00',
                    course: '30åˆ†ã‚³ãƒ¼ã‚¹',
                    email: 'debug@test.com',
                    is_new_customer: true,
                    referral_source: 'other'
                };
                
                addOutput('ãƒ†ã‚¹ãƒˆäºˆç´„', 'ãƒ†ã‚¹ãƒˆäºˆç´„ä½œæˆä¸­...', 'info');
                addOutput('é€ä¿¡ãƒ‡ãƒ¼ã‚¿', testData, 'info');
                
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .insert([testData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                addOutput('ãƒ†ã‚¹ãƒˆäºˆç´„', 'âœ… ãƒ†ã‚¹ãƒˆäºˆç´„ä½œæˆæˆåŠŸï¼', 'success');
                addOutput('ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿', data, 'success');
                
            } catch (error) {
                addOutput('ãƒ†ã‚¹ãƒˆäºˆç´„ã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`, 'error');
                console.error('ãƒ†ã‚¹ãƒˆäºˆç´„ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }

        async function listAllReservations() {
            try {
                addOutput('å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º', 'å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                addOutput('å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º', `âœ… å–å¾—æˆåŠŸ: ${data.length}ä»¶`, 'success');
                
                if (data.length > 0) {
                    addOutput('äºˆç´„ä¸€è¦§', data, 'info');
                } else {
                    addOutput('äºˆç´„ä¸€è¦§', 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™', 'info');
                }
                
            } catch (error) {
                addOutput('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            try {
                addOutput('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤', 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .delete()
                    .eq('name', 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ');
                
                if (error) {
                    throw error;
                }
                
                addOutput('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤', 'âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†', 'success');
                
            } catch (error) {
                addOutput('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆ
        window.onload = async function() {
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSupabaseConnection();
        };
    </script>
</body>
</html>