<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å’Œæ•´éª¨é™¢ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  - æœ€çµ‚ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .loading { background: #e2e3e5; border-color: #d6d8db; }
        .test-result { margin: 10px 0; padding: 10px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å’Œæ•´éª¨é™¢ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  - æœ€çµ‚ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆé …ç›®</h2>
        <button onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="testDatabase()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testReservationFlow()">ğŸ“… äºˆç´„ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testAdminSystem()">ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testCalendar()">ğŸ“† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testEmail()">ğŸ“§ ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div id="testResults"></div>

    <!-- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="config/env.js"></script>
    <script src="config/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script>
        let supabaseClient;
        let testResults = [];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const supabaseConfig = window.AppConfig.getSupabaseConfig();
                supabaseClient = supabase.createClient(supabaseConfig.url, supabaseConfig.key);
                
                const emailConfig = window.AppConfig.getEmailJSConfig();
                emailjs.init(emailConfig.publicKey);
                
                console.log('âœ… ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                addResult('åˆæœŸåŒ–', 'è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                addResult('åˆæœŸåŒ–', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        function addResult(test, message, type) {
            const result = { test, message, type, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('testResults');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result ${type}`;
            testDiv.innerHTML = `
                <strong>[${result.timestamp}] ${result.test}:</strong> ${result.message}
            `;
            resultsDiv.appendChild(testDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            
            addResult('ã‚·ã‚¹ãƒ†ãƒ ', 'å…¨ãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            await testDatabase();
            await testCalendar();
            await testReservationFlow();
            await testAdminSystem();
            await testEmail();
            
            // çµæœã‚µãƒãƒªãƒ¼
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            const summaryType = errorCount > 0 ? 'error' : (warningCount > 0 ? 'warning' : 'success');
            addResult('å®Œäº†', `ãƒ†ã‚¹ãƒˆå®Œäº† - æˆåŠŸ:${successCount}, ã‚¨ãƒ©ãƒ¼:${errorCount}, è­¦å‘Š:${warningCount}`, summaryType);
        }

        async function testDatabase() {
            addResult('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', 'Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            try {
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                addResult('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', 'âœ… Supabaseæ¥ç¶šæˆåŠŸ', 'success');
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ç¢ºèª
                const tables = ['reservations', 'admin_users', 'schedule_overrides'];
                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('*')
                            .limit(1);
                        
                        if (error) throw error;
                        addResult('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', `âœ… ${table}ãƒ†ãƒ¼ãƒ–ãƒ«æ­£å¸¸`, 'success');
                    } catch (err) {
                        addResult('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', `âŒ ${table}ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                    }
                }
                
            } catch (error) {
                addResult('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', `âŒ æ¥ç¶šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testCalendar() {
            addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            try {
                // ç¥æ—¥åˆ¤å®šãƒ†ã‚¹ãƒˆ
                const testDate = new Date('2025-01-01'); // å…ƒæ—¥
                const isHoliday = window.isJapaneseHoliday && window.isJapaneseHoliday(testDate);
                
                if (isHoliday) {
                    addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', 'âœ… ç¥æ—¥åˆ¤å®šæ©Ÿèƒ½æ­£å¸¸', 'success');
                } else {
                    addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', 'âš ï¸ ç¥æ—¥åˆ¤å®šæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚‰ãªã„', 'warning');
                }
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                const testScheduleDate = '2025-12-31';
                try {
                    const { data, error } = await supabaseClient
                        .from('schedule_overrides')
                        .select('*')
                        .eq('date', testScheduleDate);
                    
                    if (error) throw error;
                    addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', 'âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†æ©Ÿèƒ½æ­£å¸¸', 'success');
                } catch (err) {
                    addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', `âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                }
                
            } catch (error) {
                addResult('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', `âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testReservationFlow() {
            addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', 'äºˆç´„ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            try {
                // ãƒ†ã‚¹ãƒˆäºˆç´„ãƒ‡ãƒ¼ã‚¿
                const testReservation = {
                    name: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                    phone: '090-0000-0000',
                    datetime: '2025-12-20T10:00',
                    course: '30åˆ†ã‚³ãƒ¼ã‚¹',
                    email: 'test@example.com',
                    is_new_customer: true,
                    referral_source: 'google_search'
                };
                
                // äºˆç´„ä½œæˆãƒ†ã‚¹ãƒˆ
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('reservations')
                    .insert([testReservation])
                    .select();
                
                if (insertError) throw insertError;
                
                const reservationId = insertData[0].id;
                addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', 'âœ… äºˆç´„ä½œæˆæˆåŠŸ', 'success');
                
                // äºˆç´„ç¢ºèªãƒ†ã‚¹ãƒˆ
                const { data: selectData, error: selectError } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .eq('id', reservationId);
                
                if (selectError) throw selectError;
                
                if (selectData.length > 0) {
                    addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', 'âœ… äºˆç´„ãƒ‡ãƒ¼ã‚¿ç¢ºèªæˆåŠŸ', 'success');
                } else {
                    addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', 'âŒ äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„', 'error');
                }
                
                // äºˆç´„å‰Šé™¤ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
                const { error: deleteError } = await supabaseClient
                    .from('reservations')
                    .delete()
                    .eq('id', reservationId);
                
                if (deleteError) throw deleteError;
                addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', 'âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†', 'success');
                
            } catch (error) {
                addResult('äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testAdminSystem() {
            addResult('ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', 'ç®¡ç†è€…ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            try {
                // ç®¡ç†è€…èªè¨¼ãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabaseClient
                    .from('admin_users')
                    .select('*')
                    .eq('id', 'admin_k7m9p2x4q8');
                
                if (error) throw error;
                
                if (data.length > 0) {
                    addResult('ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', 'âœ… ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª', 'success');
                } else {
                    addResult('ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', 'âŒ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„', 'error');
                }
                
                // äºˆç´„ä¸€è¦§å–å¾—ãƒ†ã‚¹ãƒˆ
                const { data: reservations, error: reservationError } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('datetime', { ascending: true });
                
                if (reservationError) throw reservationError;
                
                addResult('ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', `âœ… äºˆç´„ä¸€è¦§å–å¾—æˆåŠŸ (${reservations.length}ä»¶)`, 'success');
                
            } catch (error) {
                addResult('ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testEmail() {
            addResult('ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', 'EmailJSè¨­å®šãƒ†ã‚¹ãƒˆé–‹å§‹', 'loading');
            
            try {
                const emailConfig = window.AppConfig.getEmailJSConfig();
                
                if (emailConfig.publicKey && emailConfig.serviceId && emailConfig.templateId) {
                    addResult('ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', 'âœ… EmailJSè¨­å®šç¢ºèª', 'success');
                } else {
                    addResult('ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', 'âš ï¸ EmailJSè¨­å®šãŒä¸å®Œå…¨', 'warning');
                }
                
                // å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆã¯æœ¬ç•ªç’°å¢ƒã§ã¯è¡Œã‚ãªã„
                addResult('ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', 'â„¹ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ¬ç•ªç’°å¢ƒä¿è­·ï¼‰', 'warning');
                
            } catch (error) {
                addResult('ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ç’°å¢ƒæƒ…å ±è¡¨ç¤º
        window.onload = function() {
            const envInfo = document.createElement('div');
            envInfo.className = 'test-section';
            envInfo.innerHTML = `
                <h3>ğŸŒ ç’°å¢ƒæƒ…å ±</h3>
                <p><strong>URL:</strong> ${window.location.href}</p>
                <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:</strong> ${navigator.userAgent}</p>
                <p><strong>Supabase URL:</strong> ${window.AppConfig ? window.AppConfig.getSupabaseConfig().url : 'è¨­å®šãªã—'}</p>
            `;
            document.body.insertBefore(envInfo, document.getElementById('testResults'));
        };
    </script>
</body>
</html>