<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- 設定ファイル -->
    <script src="config/env.js"></script>
    <script src="config/config.js"></script>
    <script src="calendar-sync.js"></script>
    <!-- flatpickr CSS/JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta charset="UTF-8">
    <title>和み整骨院 - 完全予約制の整骨院</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            background: #fff;
        }
        
        /* ヘッダー */
        .header {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 70px;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        .nav {
            display: flex;
            list-style: none;
        }
        .nav li {
            margin-left: 30px;
        }
        .nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav a:hover {
            color: #4caf50;
        }
        
        /* ヒーローセクション */
        .hero {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
            padding: 120px 20px 80px;
            text-align: center;
            margin-top: 70px;
        }
        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .hero p {
            font-size: 20px;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        .hero .phone {
            font-size: 32px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 50px;
            display: inline-block;
        }
        
        /* セクション共通 */
        .section {
            padding: 60px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section h2 {
            font-size: 32px;
            text-align: center;
            margin-bottom: 50px;
            color: #388e3c;
            position: relative;
        }
        .section h2::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: #81c784;
            margin: 15px auto;
        }
        
        /* 当院紹介 */
        .intro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            margin-top: 40px;
        }
        .intro-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .intro-card .icon {
            font-size: 48px;
            color: #66bb6a;
            margin-bottom: 20px;
        }
        .intro-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #388e3c;
        }
        
        /* アクセス情報 */
        .access-info {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 10px;
            margin: 40px 0;
        }
        .access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .access-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .access-item .icon {
            font-size: 24px;
            color: #66bb6a;
            margin-right: 15px;
        }
        
        /* 想い */
        .philosophy {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
            margin: 60px 0;
        }
        .philosophy h2 {
            color: white;
        }
        .philosophy h2::after {
            background: white;
        }
        .philosophy p {
            font-size: 18px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        /* メディア情報 */
        .media-section {
            background: white;
            padding: 80px 20px;
        }
        .media-content {
            display: flex;
            align-items: center;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .media-image {
            flex: 1;
        }
        .media-img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .media-text {
            flex: 1;
        }
        .media-text h3 {
            color: #66bb6a;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .media-text p {
            line-height: 1.8;
            color: #666;
        }
        
        /* ロゴコンテナ */
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .main-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* 想いセクション更新 */
        .philosophy-content {
            display: flex;
            align-items: center;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
            text-align: left;
        }
        .philosophy-image {
            flex: 1;
        }
        .philosophy-img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .philosophy-text {
            flex: 1;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .philosophy-content,
            .media-content {
                flex-direction: column;
            }
            .logo-container {
                flex-direction: column;
                gap: 10px;
            }
            .main-logo {
                width: 60px;
                height: 60px;
            }
            .access-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 予約フォーム */
        .reservation {
            background: #f8f9fa;
            padding: 60px 20px;
        }
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .booking-flow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }
        .booking-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 8px;
            border: 2px dashed #c8e6c9;
            color: #5d8a5f;
            font-weight: 600;
            background: #f9fff9;
            transition: all 0.2s ease;
        }
        .booking-step span {
            font-size: 12px;
            letter-spacing: 0.08em;
            color: #8da58f;
            margin-bottom: 4px;
        }
        .booking-step strong {
            font-size: 16px;
        }
        .booking-step.active {
            border-style: solid;
            border-color: #66bb6a;
            background: linear-gradient(135deg, #e8f5e9, #f1fff1);
            color: #1b5e20;
            box-shadow: inset 0 0 0 1px rgba(102, 187, 106, 0.3);
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #388e3c;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #81c784;
        }
        .business-hours {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }
        .business-hours h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .success {
            color: #28a745;
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
        }
        

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .modal-btn.confirm {
            background: #dc3545;
            color: white;
        }
        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                height: auto;
                padding: 15px 20px;
            }
            .nav {
                margin-top: 15px;
            }
            .nav li {
                margin-left: 20px;
            }
            .hero {
                margin-top: 120px;
                padding: 80px 20px 60px;
            }
            .hero h1 {
                font-size: 32px;
            }
            .hero p {
                font-size: 18px;
            }
            .hero .phone {
                font-size: 24px;
            }
            .section h2 {
                font-size: 28px;
            }
            .form-container {
                padding: 30px 20px;
            }
            .booking-flow {
                grid-template-columns: 1fr;
            }
        }
        
        /* flatpickr カスタムスタイル */
        .flatpickr-calendar {
            font-size: 16px;
        }
        .flatpickr-day {
            color: #333 !important;
            font-weight: 600 !important;
            font-size: 14px !important;
        }
        .flatpickr-day:hover {
            background: #e3f2fd !important;
            color: #1976d2 !important;
        }
        .flatpickr-day.selected {
            background: #4caf50 !important;
            color: white !important;
            font-weight: 700 !important;
        }
        .flatpickr-day.today {
            background: #81c784 !important;
            color: white !important;
            font-weight: 700 !important;
        }
        .flatpickr-day.disabled,
        .flatpickr-day.flatpickr-disabled {
            color: #666 !important;
            pointer-events: none !important;
        }
        .flatpickr-day:not(.flatpickr-disabled):not(.disabled) {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        .flatpickr-weekday {
            color: #555 !important;
            font-weight: 700 !important;
        }
        
        /* スムーススクロール */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="header-content">
            <div class="logo">和み整骨院</div>
            <nav>
                <ul class="nav">
                    <li><a href="#intro">当院紹介</a></li>
                    <li><a href="#access">アクセス・営業時間</a></li>
                    <li><a href="#philosophy">当院の想い</a></li>
                    <li><a href="#reservation">問い合わせ・予約</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ヒーローセクション -->
    <section class="hero">
        <div class="logo-container">
            <img src="images/logo.jpg" alt="和み整骨院" class="main-logo">
            <h1>和み整骨院</h1>
        </div>
        <p>国家資格所有者による確かな技術で<br>「痛み・不調のない日々」を取り戻すお手伝いをしています</p>
        <div class="phone">
            <i class="fas fa-phone"></i> <span id="contact-phone">0985-73-9884</span>
        </div>
        <p>完全予約制・時間外相談可</p>
    </section>

    <!-- 当院紹介 -->
    <section id="intro" class="section">
        <h2>当院紹介</h2>
        <div class="intro-grid">
            <div class="intro-card">
                <div class="icon"><i class="fas fa-user-md"></i></div>
                <h3>国家資格所有者</h3>
                <p>柔道整復師の国家資格を持つ専門家が、確かな技術で施術にあたります。安心してお任せください。</p>
            </div>
            <div class="intro-card">
                <div class="icon"><i class="fas fa-clock"></i></div>
                <h3>完全予約制</h3>
                <p>お待たせすることなく、しっかりと時間をかけて施術を行います。ご予約はお電話またはWebから。</p>
            </div>
            <div class="intro-card">
                <div class="icon"><i class="fas fa-heart"></i></div>
                <h3>根本改善</h3>
                <p>痛みの原因を根本から改善し、再発を防ぐための施術とアドバイスを行います。</p>
            </div>
        </div>
    </section>

    <!-- メディア情報 -->
    <section id="media" class="section media-section">
        <h2>メディア情報</h2>
        <div class="media-content">
            <div class="media-image">
                <img src="images/media.png" alt="メディア掲載" class="media-img">
            </div>
            <div class="media-text">
                <h3>各種メディアに掲載いただいております</h3>
                <p>
                    当院の取り組みや治療法について、各種メディアでご紹介いただいております。<br>
                    実績と信頼の証として、安心してお越しください。
                </p>
            </div>
        </div>
    </section>

    <!-- アクセス・営業時間 -->
    <section id="access" class="section">
        <h2>アクセス・営業時間</h2>
        <div class="access-info">
            <div class="access-grid">
                <div class="access-item">
                    <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div>
                        <strong>住所</strong><br>
                        〒880-0211<br>
                        宮崎県宮崎市佐土原町下田島１０２９７<br>
                        <a href="https://maps.app.goo.gl/QjzRbJwJV2uhiQ9h8" target="_blank" style="color: #4285F4; text-decoration: none; font-size: 12px;">
                            <i class="fas fa-external-link-alt"></i> Googleマップで開く
                        </a>
                    </div>
                </div>
                <div class="access-item">
                    <div class="icon"><i class="fas fa-phone"></i></div>
                    <div>
                        <strong>お電話</strong><br>
                        <span id="access-phone">0985-73-9884</span>
                    </div>
                </div>
                <div class="access-item">
                    <div class="icon"><i class="fas fa-clock"></i></div>
                    <div>
                        <strong>営業時間</strong><br>
                        平日：9:00〜19:00<br>
                        土曜：9:00〜12:00<br>
                        休診：日曜・祝日
                    </div>
                </div>
                <div class="access-item">
                    <div class="icon">
                        <a href="https://www.instagram.com/nagomi0510seikotuin/" target="_blank" style="color: #E4405F; text-decoration: none;">
                            <i class="fab fa-instagram" style="font-size: 24px;"></i>
                        </a>
                    </div>
                    <div>
                        <strong>Instagram</strong><br>
                        <a href="https://www.instagram.com/nagomi0510seikotuin/" target="_blank" style="color: #E4405F; text-decoration: none; font-size: 12px;">
                            @nagomi0510seikotuin
                        </a>
                    </div>
                </div>
                <div class="access-item">
                    <div class="icon">
                        <a href="https://line.me/R/ti/p/@osy8134l?oat_content=qr#~" target="_blank" style="color: #00C300; text-decoration: none;">
                            <i class="fab fa-line" style="font-size: 24px;"></i>
                        </a>
                    </div>
                    <div>
                        <strong>LINE</strong><br>
                        <span style="font-size: 12px; color: #666;">LINEからも連絡可能です</span>
                    </div>
                </div>
            </div>
            <p style="margin-top: 20px; text-align: center; color: #666;">
                ※時間外でもご相談に応じます。お気軽にお電話ください。
            </p>
        </div>
    </section>

    <!-- 当院の想い -->
    <section id="philosophy" class="philosophy">
        <div class="philosophy-content">
            <div class="philosophy-image">
                <img src="images/当院の想い.png" alt="当院の想い" class="philosophy-img">
            </div>
            <div class="philosophy-text">
                <h2>当院の想い</h2>
                <p>
                    痛みや不調の原因がわからない、診断を受けたけれど症状が良くならない…<br>
                    そんな方に、国家資格者の確かな技術で「痛み・不調のない日々」を取り戻すお手伝いをしています。<br><br>
                    
                    子育てや仕事で自分の身体のことを考える余裕がない方、痛みがある中でも我慢して頑張ってきた方、<br>
                    そのような方々の「痛みのない生活」を実現することが私たちの使命です。<br><br>
                    
                    腰痛、肩こり、首こり、四十肩、膝痛、頭痛など、様々な症状に対応いたします。<br>
                    お一人お一人の症状に合わせた最適な治療法をご提案させていただきます。
                </p>
            </div>
        </div>
    </section>
    <!-- 予約フォーム -->
    <section id="reservation" class="reservation">
        <div class="section">
            <h2>ご予約・お問い合わせ</h2>
            <div class="form-container">
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    Web予約は24時間受付中です。お急ぎの方はお電話にてお問い合わせください。
                </p>
                
                <form id="reserveForm">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user"></i> お名前</label>
                        <input type="text" id="name" required placeholder="山田 太郎">
                    </div>
                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> メールアドレス</label>
                        <input type="email" id="email" required placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label for="phone"><i class="fas fa-phone"></i> 電話番号</label>
                        <input type="tel" id="phone" required placeholder="090-1234-5678">
                    </div>
                    <div class="form-group">
                        <label for="is_new_customer"><i class="fas fa-user-plus"></i> 顧客区分</label>
                        <select id="is_new_customer" required>
                            <option value="">選択してください</option>
                            <option value="true">新規のお客様</option>
                            <option value="false">リピーターのお客様</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="referral_source"><i class="fas fa-route"></i> こちらを知ったきっかけ</label>
                        <select id="referral_source" required>
                            <option value="">選択してください</option>
                            <option value="instagram">Instagram</option>
                            <option value="line">LINE</option>
                            <option value="google_search">グーグル検索</option>
                            <option value="yahoo_search">ヤフー検索</option>
                            <option value="referral">知人の紹介</option>
                            <option value="flyer">チラシ・看板</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="booking-flow" id="bookingFlow">
                        <div class="booking-step active" data-step="date">
                            <span>STEP 1</span>
                            <strong>予約日</strong>
                        </div>
                        <div class="booking-step" data-step="course">
                            <span>STEP 2</span>
                            <strong>コース</strong>
                        </div>
                        <div class="booking-step" data-step="time">
                            <span>STEP 3</span>
                            <strong>可能な時間帯</strong>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="date"><i class="fas fa-calendar-alt"></i> 予約日</label>
                        <input type="text" id="date" required placeholder="カレンダーから日付を選択">
                    </div>
                    <div class="form-group">
                        <label for="course"><i class="fas fa-list"></i> コース</label>
                        <select id="course" required>
                            <option value="">まず予約日を選択してください</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="time"><i class="fas fa-clock"></i> 可能な時間帯</label>
                        <div class="business-hours">
                            <h4><i class="fas fa-info-circle"></i> 営業時間</h4>
                            <div style="line-height: 1.6;">
                                平日：9:00〜19:00 / 土曜：9:00〜12:00 / 休診：日曜・祝日
                            </div>
                        </div>
                        <select id="time" required>
                            <option value="">まず日付とコースを選択してください</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-paper-plane"></i> 予約を送信する
                    </button>
                </form>
                <div id="result" class="success" style="display: none;"></div>
            </div>
        </div>
    </section>


    <script>
        // 設定から値を取得
        const supabaseConfig = window.AppConfig.getSupabaseConfig();
        const SUPABASE_URL = supabaseConfig.url;
        const SUPABASE_KEY = supabaseConfig.key;
        const tableName = window.AppConfig.tables.reservations;
        const scheduleTable = window.AppConfig.tables.scheduleOverrides;
        const emailJSConfig = window.AppConfig.getEmailJSConfig();
        const clinicEmail = window.AppConfig.contact?.email || 'nagomi.y.c.j.t@gmail.com';
        const contactPhone = window.AppConfig.contact?.phone || '0985-73-9884';
        const todayStart = normalizeToStartOfDay(new Date());
        const dateInputElement = document.getElementById('date');
        const dateInputDefaultPlaceholder = dateInputElement?.getAttribute('placeholder') || 'カレンダーから日付を選択';
        let dateLoadingIndicator = null;
        window.emailJSEnabled = false;
        const courseSelectElement = document.getElementById('course');
        const timeSelectElement = document.getElementById('time');
        const submitButtonElement = document.querySelector('.submit-btn');
        const bookingFlowElement = document.getElementById('bookingFlow');
        const bookingStepElements = bookingFlowElement ? bookingFlowElement.querySelectorAll('.booking-step') : [];
        const COURSE_SELECT_OPTIONS = `
            <option value="">選択してください</option>
            <option value="30分コース">30分コース - 2,000円（軽度の症状・メンテナンス）</option>
            <option value="1時間コース">1時間コース - 4,000円（しっかり治療・初回推奨）</option>
        `;
        const COURSE_DURATION_MINUTES = {
            '30分コース': 30,
            '1時間コース': 60
        };
        let selectedDateValue = '';
        let selectedCourseValue = '';
        let latestTimeSlots = [];
        const calendarConfig = window.AppConfig?.calendarIntegration || null;

        const SUPABASE_PLACEHOLDER_HOSTS = ['your-project-id.supabase.co'];
        const isPlaceholderUrl = !SUPABASE_URL || SUPABASE_PLACEHOLDER_HOSTS.some(host => SUPABASE_URL.includes(host));
        const isPlaceholderKey = !SUPABASE_KEY || SUPABASE_KEY.includes('your-anon-key');
        const useLocalFallbackStore = isPlaceholderUrl || isPlaceholderKey;
        const LOCAL_STORAGE_KEYS = {
            reservations: 'nagomi_reservations_local_cache',
            scheduleOverrides: 'nagomi_schedule_local_cache'
        };
        let reservationCache = [];
        let reservationCacheFetchedAt = 0;
        const RESERVATION_CACHE_TTL = 60 * 1000; // 1分キャッシュ

        window.AppState = Object.assign({}, window.AppState, {
            dataSource: useLocalFallbackStore ? 'local-storage' : 'supabase',
            supabaseUrl: SUPABASE_URL
        });

        function ensureDateLoadingIndicator() {
            if (!dateInputElement || dateLoadingIndicator) {
                return;
            }
            dateLoadingIndicator = document.createElement('div');
            dateLoadingIndicator.id = 'date-loading-status';
            dateLoadingIndicator.style.marginTop = '6px';
            dateLoadingIndicator.style.fontSize = '12px';
            dateLoadingIndicator.style.color = '#666';
            dateLoadingIndicator.style.display = 'none';
            dateInputElement.parentElement?.appendChild(dateLoadingIndicator);
        }

        function setDateInputLoading(isLoading, message = '読み込み中です...') {
            if (!dateInputElement) {
                return;
            }
            ensureDateLoadingIndicator();
            if (isLoading) {
                dateInputElement.setAttribute('disabled', 'disabled');
                dateInputElement.placeholder = message;
                if (dateLoadingIndicator) {
                    dateLoadingIndicator.textContent = message;
                    dateLoadingIndicator.style.display = 'block';
                }
            } else {
                dateInputElement.removeAttribute('disabled');
                dateInputElement.placeholder = dateInputDefaultPlaceholder;
                if (dateLoadingIndicator) {
                    dateLoadingIndicator.style.display = 'none';
                }
            }
        }

        setDateInputLoading(true, '予約日を準備中です...');

        function updateBookingStepsState({ date = false, course = false, time = false }) {
            bookingStepElements.forEach(step => {
                const stepName = step.dataset.step;
                const isActive = (stepName === 'date' && date) ||
                                (stepName === 'course' && course) ||
                                (stepName === 'time' && time);
                step.classList.toggle('active', isActive);
            });
        }

        function renderCourseSelect(disabledMessage = null) {
            if (!courseSelectElement) return;
            if (disabledMessage) {
                courseSelectElement.innerHTML = `<option value="">${disabledMessage}</option>`;
                courseSelectElement.disabled = true;
                return;
            }
            courseSelectElement.disabled = false;
            courseSelectElement.innerHTML = COURSE_SELECT_OPTIONS;
            courseSelectElement.value = '';
        }

        function resetTimeSelect(message = 'まず日付とコースを選択してください') {
            if (!timeSelectElement) return;
            timeSelectElement.innerHTML = `<option value="">${message}</option>`;
            timeSelectElement.disabled = true;
            timeSelectElement.value = '';
        }

        function populateTimeSelect(slots) {
            if (!timeSelectElement) return;
            if (!slots || !slots.length) {
                resetTimeSelect('選択した条件で予約可能な時間がありません');
                return;
            }
            const options = slots.map(slot => {
                const status = slot.isSpecial ? '〇（特別営業）' : '〇';
                return `<option value="${slot.time}">${slot.time} ${status}</option>`;
            }).join('');
            timeSelectElement.innerHTML = options;
            timeSelectElement.disabled = false;
            timeSelectElement.value = '';
        }

        function setSubmitDisabled(message) {
            if (!submitButtonElement) return;
            submitButtonElement.disabled = true;
            submitButtonElement.style.opacity = '0.5';
            submitButtonElement.style.cursor = 'not-allowed';
            submitButtonElement.innerHTML = `<i class="fas fa-ban"></i> ${message}`;
        }

        function setSubmitEnabled() {
            if (!submitButtonElement) return;
            submitButtonElement.disabled = false;
            submitButtonElement.style.opacity = '1';
            submitButtonElement.style.cursor = 'pointer';
            submitButtonElement.innerHTML = '<i class="fas fa-paper-plane"></i> 予約を送信する';
        }

        function getCourseDuration(courseName) {
            return COURSE_DURATION_MINUTES[courseName] || 30;
        }

        function getCalendarIntegrationFlag(value) {
            if (typeof value === 'function') {
                try {
                    return value();
                } catch (error) {
                    console.warn('[CalendarSync] 設定取得エラー:', error);
                    return null;
                }
            }
            return value;
        }

        function isCalendarIntegrationAvailable() {
            if (!calendarConfig) {
                return false;
            }
            const enabled = getCalendarIntegrationFlag(calendarConfig.enabled);
            const endpoint = getCalendarIntegrationFlag(calendarConfig.endpoint);
            return !!(enabled && endpoint && window.CalendarSync?.sync);
        }

        async function syncCalendarReservation(action, reservation) {
            if (!isCalendarIntegrationAvailable()) {
                return { skipped: true };
            }
            try {
                return await window.CalendarSync.sync(action, reservation);
            } catch (error) {
                console.warn('[CalendarSync] 連携に失敗しました:', error);
                return { error };
            }
        }

        updateBookingStepsState({ date: true, course: false, time: false });
        renderCourseSelect('まず予約日を選択してください');
        resetTimeSelect('まず日付とコースを選択してください');
        setSubmitDisabled('まず日付と時間を選択してください');


        function readLocalData(key) {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : [];
            } catch (error) {
                console.error('ローカルデータの読み込みに失敗しました:', error);
                return [];
            }
        }

        function writeLocalData(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error('ローカルデータの保存に失敗しました:', error);
            }
        }

        async function querySupabase(description, executor, fallbackData = null) {
            if (!window.supabase) {
                return { data: fallbackData, error: new Error('Supabase client is not available') };
            }
            try {
                const result = await executor();
                if (result?.error) {
                    console.error(`Supabase応答エラー (${description})`, result.error);
                }
                return {
                    data: result?.data ?? fallbackData,
                    error: result?.error ?? null
                };
            } catch (error) {
                console.error(`Supabase通信エラー (${description})`, error);
                return { data: fallbackData, error };
            }
        }

        async function fetchReservationsFromSource(selectClause = 'datetime, course') {
            if (useLocalFallbackStore) {
                const localData = readLocalData(LOCAL_STORAGE_KEYS.reservations);
                return Array.isArray(localData) ? localData : [];
            }
            const { data } = await querySupabase('予約データ取得', () =>
                window.supabase.from(tableName).select(selectClause)
            , []);
            return Array.isArray(data) ? data : [];
        }

        async function getReservationData(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && reservationCache.length && (now - reservationCacheFetchedAt) < RESERVATION_CACHE_TTL) {
                return reservationCache;
            }
            const data = await fetchReservationsFromSource('datetime, course');
            reservationCache = Array.isArray(data) ? data : [];
            reservationCacheFetchedAt = now;
            return reservationCache;
        }

        async function fetchScheduleOverrides(date, status = null) {
            if (useLocalFallbackStore) {
                const overrides = readLocalData(LOCAL_STORAGE_KEYS.scheduleOverrides);
                return overrides.filter(entry => entry.date === date && (!status || entry.status === status));
            }
            const { data } = await querySupabase('スケジュール設定取得', () => {
                let query = window.supabase.from(scheduleTable).select('*').eq('date', date);
                if (status) {
                    query = query.eq('status', status);
                }
                return query;
            }, []);
            return Array.isArray(data) ? data : [];
        }

        async function insertReservationRecord(record) {
            if (useLocalFallbackStore) {
                const reservations = readLocalData(LOCAL_STORAGE_KEYS.reservations);
                const storedRecord = Object.assign({ id: `local-${Date.now()}` }, record);
                reservations.push(storedRecord);
                writeLocalData(LOCAL_STORAGE_KEYS.reservations, reservations);
                return { data: [storedRecord], error: null, source: 'local' };
            }
            return await querySupabase('予約登録', () =>
                window.supabase.from(tableName).insert([record]).select()
            );
        }

        async function fetchReservationsByDateTime(datetime) {
            if (useLocalFallbackStore) {
                const reservations = await getReservationData();
                return reservations.filter(entry => entry.datetime === datetime);
            }
            const { data } = await querySupabase('予約重複確認', () =>
                window.supabase.from(tableName).select('*').eq('datetime', datetime)
            , []);
            return Array.isArray(data) ? data : [];
        }

        // 連絡先情報を動的に設定
        function updateContactInfo() {
            const contactConfig = window.AppConfig.contact;
            document.getElementById('contact-phone').textContent = contactConfig.phone;
            document.getElementById('access-phone').textContent = contactConfig.phone;
            
            // InstagramとLINEのリンクも更新
            const instagramLinks = document.querySelectorAll('a[href*="instagram"]');
            instagramLinks.forEach(link => {
                link.href = contactConfig.instagram;
            });
            
            const lineLinks = document.querySelectorAll('a[href*="line.me"]');
            lineLinks.forEach(link => {
                link.href = contactConfig.line;
            });
            
            // Instagram handleも更新
            const instagramHandle = document.querySelector('a[href*="instagram"] + div');
            if (instagramHandle) {
                const handleElement = instagramHandle.querySelector('a');
                if (handleElement) {
                    handleElement.textContent = contactConfig.instagramHandle;
                }
            }
        }

        function initEmailJS() {
            if (window.emailJSEnabled) {
                return;
            }
            if (typeof emailjs === 'undefined') {
                console.error('EmailJS SDKが読み込まれていません');
                return;
            }
            if (!emailJSConfig.publicKey || !emailJSConfig.serviceId || !emailJSConfig.templateId) {
                console.warn('EmailJS設定が不完全なため初期化できません');
                return;
            }
            try {
                emailjs.init(emailJSConfig.publicKey);
                window.emailJSEnabled = true;
                window.AppLogger?.info('EmailJS初期化完了', {
                    serviceId: emailJSConfig.serviceId,
                    templateId: emailJSConfig.templateId
                });
            } catch (error) {
                window.emailJSEnabled = false;
                console.error('EmailJS初期化に失敗しました:', error);
            }
        }
        initEmailJS();

        // Supabase JSライブラリを読み込み、初期化後にアプリを起動
        function bootstrapSupabase() {
            if (useLocalFallbackStore) {
                console.warn('Supabase設定が見つからないため、ローカルストレージモードで動作します。CONFIGURATION_SETUP.md を参照して本番用の接続情報を設定してください。');
                initApp();
                return;
            }

            if (window.supabase) {
                initApp();
                return;
            }

            if (document.querySelector('script[data-supabase-sdk]')) {
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js';
            script.async = true;
            script.defer = true;
            script.dataset.supabaseSdk = 'true';
            script.onload = () => {
                try {
                    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    initApp();
                } catch (error) {
                    console.error('Supabase初期化に失敗しました:', error);
                }
            };
            script.onerror = (error) => {
                console.error('Supabase SDKの読み込みに失敗しました:', error);
            };
            document.head.appendChild(script);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bootstrapSupabase);
        } else {
            bootstrapSupabase();
        }

        // スケジュール管理関数
        function resolveScheduleStatusFromData(data, time = null) {
            if (!data || data.length === 0) {
                return null;
            }

            const normalizeTime = (value) => typeof value === 'string' ? value.slice(0, 5) : '';
            const prioritized = data.slice().sort((a, b) => {
                if (a.status === b.status) {
                    return 0;
                }
                return a.status === 'closed' ? -1 : 1;
            });

            const dayClosedEntry = prioritized.find(entry => entry.time === null && !entry.start_time && !entry.end_time && entry.status === 'closed');
            const dayOpenEntry = prioritized.find(entry => entry.time === null && !entry.start_time && !entry.end_time && entry.status === 'open');
            const hasOpenRange = prioritized.some(entry => entry.status === 'open' && (entry.start_time || entry.time));

            if (!time) {
                if (dayClosedEntry) {
                    return 'closed';
                }
                if (dayOpenEntry || hasOpenRange) {
                    return 'open';
                }
                return null;
            }

            const targetTime = normalizeTime(time);
            for (const schedule of prioritized) {
                const startTime = normalizeTime(schedule.start_time);
                const endTime = normalizeTime(schedule.end_time);

                if (schedule.start_time && schedule.end_time) {
                    if (targetTime >= startTime && targetTime < endTime) {
                        console.log(`範囲マッチ: ${schedule.date} ${targetTime} -> ${schedule.status}`);
                        return schedule.status;
                    }
                }

                if (schedule.time) {
                    if (normalizeTime(schedule.time) === targetTime) {
                        console.log(`時間マッチ: ${schedule.date} ${targetTime} -> ${schedule.status}`);
                        return schedule.status;
                    }
                }
            }

            if (dayClosedEntry) {
                return 'closed';
            }
            if (dayOpenEntry) {
                return 'open';
            }
            return null;
        }

        async function checkScheduleOverride(date, time = null, preloadedData = null) {
            try {
                const data = preloadedData || await fetchScheduleOverrides(date);
                return resolveScheduleStatusFromData(data, time);
            } catch (error) {
                console.error('スケジュール確認エラー:', error);
                return null;
            }
        }

        // 日本の祝日判定機能
        function isJapaneseHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();
            
            // 固定祝日
            const fixedHolidays = {
                '1-1': '元日',
                '2-11': '建国記念の日',
                '2-23': '天皇誕生日',
                '4-29': 'みどりの日',
                '5-3': '憲法記念日',
                '5-4': 'みどりの日',
                '5-5': 'こどもの日',
                '8-11': '山の日',
                '11-3': '文化の日',
                '11-23': '勤労感謝の日'
            };
            
            const key = `${month}-${day}`;
            if (fixedHolidays[key]) {
                return fixedHolidays[key];
            }
            
            // ハッピーマンデー等の移動祝日
            if (month === 1) {
                // 成人の日（1月第2月曜日）
                const secondMonday = getWeekdayInMonth(year, 1, 1, 2);
                if (day === secondMonday) return '成人の日';
            }
            
            if (month === 3) {
                // 春分の日（概算）
                const springEquinox = Math.floor(20.8431 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
                if (day === springEquinox) return '春分の日';
            }
            
            if (month === 7) {
                // 海の日（7月第3月曜日）
                const thirdMonday = getWeekdayInMonth(year, 7, 1, 3);
                if (day === thirdMonday) return '海の日';
            }
            
            if (month === 9) {
                // 敬老の日（9月第3月曜日）
                const thirdMonday = getWeekdayInMonth(year, 9, 1, 3);
                if (day === thirdMonday) return '敬老の日';
                
                // 秋分の日（概算）
                const autumnEquinox = Math.floor(23.2488 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
                if (day === autumnEquinox) return '秋分の日';
            }
            
            if (month === 10) {
                // スポーツの日（10月第2月曜日）
                const secondMonday = getWeekdayInMonth(year, 10, 1, 2);
                if (day === secondMonday) return 'スポーツの日';
            }
            
            // 振替休日
            const prevDay = new Date(date);
            prevDay.setDate(day - 1);
            if (dayOfWeek === 1 && isJapaneseHoliday(prevDay)) { // 月曜日で前日が祝日
                return '振替休日';
            }
            
            return null;
        }
        
        // 指定した月の第N曜日の日付を取得
        function getWeekdayInMonth(year, month, dayOfWeek, weekNumber) {
            const firstDay = new Date(year, month - 1, 1);
            const firstWeekday = firstDay.getDay();
            let targetDate = 1 + (dayOfWeek - firstWeekday + 7) % 7;
            targetDate += (weekNumber - 1) * 7;
            return targetDate;
        }

        // 日本の祝日判定機能
        function isJapaneseHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();
            
            // 固定祝日
            const fixedHolidays = {
                '1-1': '元日',
                '2-11': '建国記念の日',
                '2-23': '天皇誕生日',
                '4-29': 'みどりの日',
                '5-3': '憲法記念日',
                '5-4': 'みどりの日',
                '5-5': 'こどもの日',
                '8-11': '山の日',
                '11-3': '文化の日',
                '11-23': '勤労感謝の日'
            };
            
            const key = `${month}-${day}`;
            if (fixedHolidays[key]) {
                return fixedHolidays[key];
            }
            
            // ハッピーマンデー等の移動祝日
            if (month === 1) {
                // 成人の日（1月第2月曜日）
                const secondMonday = getWeekdayInMonth(year, 1, 1, 2);
                if (day === secondMonday) return '成人の日';
            }
            
            if (month === 3) {
                // 春分の日（概算）
                const springEquinox = Math.floor(20.8431 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
                if (day === springEquinox) return '春分の日';
            }
            
            if (month === 7) {
                // 海の日（7月第3月曜日）
                const thirdMonday = getWeekdayInMonth(year, 7, 1, 3);
                if (day === thirdMonday) return '海の日';
            }
            
            if (month === 9) {
                // 敬老の日（9月第3月曜日）
                const thirdMonday = getWeekdayInMonth(year, 9, 1, 3);
                if (day === thirdMonday) return '敬老の日';
                
                // 秋分の日（概算）
                const autumnEquinox = Math.floor(23.2488 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
                if (day === autumnEquinox) return '秋分の日';
            }
            
            if (month === 10) {
                // スポーツの日（10月第2月曜日）
                const secondMonday = getWeekdayInMonth(year, 10, 1, 2);
                if (day === secondMonday) return 'スポーツの日';
            }
            
            // 振替休日
            const prevDay = new Date(date);
            prevDay.setDate(day - 1);
            if (dayOfWeek === 1 && isJapaneseHoliday(prevDay)) { // 月曜日で前日が祝日
                return '振替休日';
            }
            
            return null;
        }
        
        // 指定した月の第N曜日の日付を取得
        function getWeekdayInMonth(year, month, dayOfWeek, weekNumber) {
            const firstDay = new Date(year, month - 1, 1);
            const firstWeekday = firstDay.getDay();
            let targetDate = 1 + (dayOfWeek - firstWeekday + 7) % 7;
            targetDate += (weekNumber - 1) * 7;
            return targetDate;
        }

        // リファラー自動検出
        function detectReferralSource() {
            const referrer = document.referrer.toLowerCase();
            
            // URLパラメータからの検出
            const urlParams = new URLSearchParams(window.location.search);
            const utmSource = urlParams.get('utm_source');
            const ref = urlParams.get('ref');
            
            if (utmSource) {
                switch(utmSource) {
                    case 'instagram': return 'instagram';
                    case 'line': return 'line';
                    case 'google': return 'google_search';
                    case 'yahoo': return 'yahoo_search';
                    default: return 'other';
                }
            }
            
            if (ref) {
                switch(ref) {
                    case 'ig': return 'instagram';
                    case 'line': return 'line';
                    default: return 'other';
                }
            }
            
            // リファラーからの検出
            if (referrer.includes('instagram.com')) return 'instagram';
            if (referrer.includes('line.me') || referrer.includes('liff.line.me')) return 'line';
            if (referrer.includes('google.com') || referrer.includes('google.co.jp')) return 'google_search';
            if (referrer.includes('yahoo.com') || referrer.includes('yahoo.co.jp')) return 'yahoo_search';
            
            // 直接アクセスの場合は空文字（ユーザーに選択させる）
            return '';
        }

        // 日付比較ヘルパー
        function normalizeToStartOfDay(input) {
            if (!input) return null;
            const date = input instanceof Date ? new Date(input.getTime()) : new Date(input);
            if (isNaN(date)) return null;
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function isPastDate(input) {
            const normalized = normalizeToStartOfDay(input);
            if (!normalized) return false;
            return normalized < todayStart;
        }

        function addMinutesToTimeStr(timeStr, minutes) {
            if (!timeStr) return '';
            const [hour, min] = timeStr.split(':').map(Number);
            const base = new Date();
            base.setHours(hour, min, 0, 0);
            base.setMinutes(base.getMinutes() + minutes);
            return `${String(base.getHours()).padStart(2, '0')}:${String(base.getMinutes()).padStart(2, '0')}`;
        }

        function minutesFromTimeString(value) {
            if (!value) {
                return NaN;
            }
            const [hour, minute] = value.split(':').map(Number);
            if (Number.isNaN(hour) || Number.isNaN(minute)) {
                return NaN;
            }
            return hour * 60 + minute;
        }

        function generateTimeSequence(startTime, endTime) {
            const slots = [];
            const startMinutes = minutesFromTimeString(startTime);
            const endMinutes = minutesFromTimeString(endTime);
            if (Number.isNaN(startMinutes) || Number.isNaN(endMinutes)) {
                return slots;
            }
            const lastBookable = endMinutes - 30;
            for (let current = startMinutes; current <= lastBookable; current += 30) {
                const hour = Math.floor(current / 60);
                const minute = current % 60;
                slots.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
            }
            return slots;
        }

        function buildReservedSet(reservations = []) {
            const reservedSet = new Set();
            (reservations || []).forEach(r => {
                if (!r?.datetime) {
                    return;
                }
                const base = r.datetime.slice(0, 16);
                reservedSet.add(base);
                if (r.course === '1時間コース') {
                    const [datepart, timepart] = r.datetime.split('T');
                    if (!datepart || !timepart) {
                        return;
                    }
                    const [hour, min] = timepart.split(':');
                    const dt = new Date();
                    const [year, month, day] = datepart.split('-');
                    dt.setFullYear(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));
                    dt.setHours(parseInt(hour, 10), parseInt(min, 10), 0, 0);
                    dt.setMinutes(dt.getMinutes() + 30);
                    const overflowKey = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}T${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`;
                    reservedSet.add(overflowKey.slice(0, 16));
                }
            });
            return reservedSet;
        }

        function filterSlotsByCourse(slots, courseName) {
            const duration = getCourseDuration(courseName);
            if (duration <= 30) {
                return slots;
            }
            const requiredSteps = Math.ceil(duration / 30);
            const slotSet = new Set(slots.map(slot => slot.time));
            return slots.filter(slot => {
                let nextTime = slot.time;
                for (let i = 1; i < requiredSteps; i++) {
                    nextTime = addMinutesToTimeStr(nextTime, 30);
                    if (!nextTime || !slotSet.has(nextTime)) {
                        return false;
                    }
                }
                return true;
            });
        }

        async function buildBaseTimeSlots(dateStr) {
            if (!dateStr) {
                return { status: 'invalid', message: '日付が選択されていません', slots: [] };
            }
            const dateObj = new Date(`${dateStr}T00:00:00`);
            if (Number.isNaN(dateObj.getTime())) {
                return { status: 'invalid', message: '有効な日付を選択してください', slots: [] };
            }

            const day = dateObj.getDay();
            const holidayName = isJapaneseHoliday(dateObj);
            const scheduleEntries = await fetchScheduleOverrides(dateStr);
            const dayOverride = resolveScheduleStatusFromData(scheduleEntries, null);

            if (dayOverride === 'closed') {
                return { status: 'closed', message: '管理者設定により休業です', slots: [] };
            }

            const weekdayRange = { start: '09:00', end: '19:00' };
            const saturdayRange = { start: '09:00', end: '12:00' };
            let times = [];

            const customOpenEntry = (scheduleEntries || []).find(entry => entry.status === 'open' && entry.start_time && entry.end_time);

            if (day >= 1 && day <= 5) {
                times = generateTimeSequence(weekdayRange.start, weekdayRange.end);
            } else if (day === 6) {
                times = generateTimeSequence(saturdayRange.start, saturdayRange.end);
            } else {
                if (dayOverride === 'open') {
                    if (customOpenEntry) {
                        times = generateTimeSequence(customOpenEntry.start_time, customOpenEntry.end_time);
                    } else {
                        times = generateTimeSequence(weekdayRange.start, weekdayRange.end);
                    }
                } else {
                    const message = holidayName ? `休診日（${holidayName}）です` : '休診日です';
                    return { status: 'closed', message, slots: [] };
                }
            }

            if (!times.length) {
                return { status: 'closed', message: '予約可能な時間が設定されていません', slots: [] };
            }

            const reservations = await getReservationData();
            const reservedSet = buildReservedSet(reservations);
            const slots = [];

            for (const time of times) {
                const datetimeKey = `${dateStr}T${time}`.slice(0, 16);
                const isReserved = reservedSet.has(datetimeKey);
                const timeOverride = resolveScheduleStatusFromData(scheduleEntries, time);

                if (!isReserved && timeOverride !== 'closed') {
                    slots.push({
                        time,
                        isSpecial: timeOverride === 'open'
                    });
                }
            }

            if (!slots.length) {
                return { status: 'full', message: '全て予約済みです', slots: [] };
            }

            return {
                status: 'ok',
                slots,
                holidayName,
                message: ''
            };
        }

        async function initApp() {
            // 連絡先情報を更新
            updateContactInfo();
            
            // リファラー自動設定
            const detectedSource = detectReferralSource();
            if (detectedSource) {
                const referralSelect = document.getElementById('referral_source');
                if (referralSelect) {
                    referralSelect.value = detectedSource;
                }
            }

            // flatpickrカレンダーUI初期化
            window.calendar = flatpickr('#date', {
                locale: flatpickr.l10ns.ja,
                minDate: todayStart,
                dateFormat: 'Y-m-d',
                disable: [
                    // 日曜日と祝日を無効化（管理者設定で上書き可能）
                    function(date) {
                        const normalized = normalizeToStartOfDay(date);
                        if (!normalized) {
                            return true;
                        }
                        if (normalized < todayStart) {
                            return true;
                        }
                        return date.getDay() === 0 || isJapaneseHoliday(date);
                    }
                ],
                enable: [], // 管理者設定の日曜日を後で追加
                onDayCreate: async function(dObj, dStr, fp, dayElem) {
                    // ローカル日付で正確な日付文字列を生成
                    const year = dayElem.dateObj.getFullYear();
                    const month = String(dayElem.dateObj.getMonth() + 1).padStart(2, '0');
                    const date = String(dayElem.dateObj.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${date}`;
                    const day = dayElem.dateObj.getDay();
                    const holidayName = isJapaneseHoliday(dayElem.dateObj);
                    const normalizedDate = normalizeToStartOfDay(dayElem.dateObj);
                    if (!normalizedDate || normalizedDate < todayStart) {
                        dayElem.innerHTML += '<span style="color:red;font-size:1.2em;">×</span>';
                        dayElem.style.background = '#ffebee';
                        dayElem.style.pointerEvents = 'none';
                        dayElem.classList.add('flatpickr-disabled');
                        return;
                    }
                    
                    console.log(`カレンダー表示処理: ${dateStr} (曜日:${day}, 祝日:${holidayName || 'なし'})`);
                    
                    // 管理者設定の終日休業チェック
                    const dayOverride = await checkScheduleOverride(dateStr);
                    console.log(`管理者設定確認: ${dateStr} -> ${dayOverride}`);
                    
                    if (dayOverride === 'closed') {
                        // 管理者が休業設定した日
                        dayElem.innerHTML += '<span style="color:red;font-size:1.2em;">×</span>';
                        dayElem.style.background = '#ffebee';
                        dayElem.style.pointerEvents = 'none';
                        dayElem.classList.add('flatpickr-disabled');
                        console.log(`休業設定適用: ${dateStr}`);
                        return;
                    }
                    
                    // 通常の休診日（日曜・祝日）の処理
                    if (day === 0 || holidayName) { // 日曜日または祝日
                        if (dayOverride === 'open') {
                            // 管理者が営業設定した日曜・祝日 → 営業日として表示
                            const specialText = holidayName ? `特別営業（${holidayName}）` : '特別営業（日）';
                            dayElem.innerHTML += '<span style="color:green;font-size:1.2em;">〇</span>';
                            dayElem.style.background = '#e8f5e8';
                            dayElem.style.pointerEvents = 'auto';
                            dayElem.classList.remove('flatpickr-disabled');
                            dayElem.removeAttribute('aria-disabled');
                            dayElem.setAttribute('tabindex', '0');
                            dayElem.title = specialText;
                            console.log(`${holidayName ? '祝日' : '日曜'}営業設定適用: ${dateStr} -> 営業日`);
                            return;
                        } else {
                            // 通常の日曜・祝日（休診日）
                            const restText = holidayName ? `休診日（${holidayName}）` : '休診日（日曜）';
                            dayElem.innerHTML += '<span style="color:red;font-size:1.2em;">×</span>';
                            dayElem.style.background = '#ffebee';
                            dayElem.style.pointerEvents = 'none';
                            dayElem.classList.add('flatpickr-disabled');
                            dayElem.title = restText;
                            console.log(`通常の${holidayName ? '祝日' : '日曜日'}: ${dateStr} -> 休診`);
                            return;
                        }
                    }
                    
                    // 管理者が特別営業設定（平日・土曜でも特別営業の場合）
                    if (dayOverride === 'open') {
                        dayElem.innerHTML += '<span style="color:blue;font-size:1.2em;">〇</span>';
                        dayElem.style.background = '#e3f2fd';
                        dayElem.style.pointerEvents = 'auto';
                        dayElem.classList.remove('flatpickr-disabled');
                        dayElem.removeAttribute('aria-disabled');
                        dayElem.setAttribute('tabindex', '0');
                        return;
                    }
                    
                    // 営業日の空き状況確認
                    let times = [];
                    if (day >= 1 && day <= 5) {
                        for (let h = 9; h <= 18; h++) {
                            times.push(`${h.toString().padStart(2, '0')}:00`);
                            times.push(`${h.toString().padStart(2, '0')}:30`);
                        }
                    } else if (day === 6) {
                        for (let h = 9; h <= 11; h++) {
                            times.push(`${h.toString().padStart(2, '0')}:00`);
                            times.push(`${h.toString().padStart(2, '0')}:30`);
                        }
                        // 12:00は削除（11:30が最後の予約可能時間）
                    } else {
                        // 日曜・祝日でも管理者営業設定がある場合は時間を設定
                        if (dayOverride === 'open') {
                            for (let h = 9; h <= 18; h++) {
                                times.push(`${h.toString().padStart(2, '0')}:00`);
                                times.push(`${h.toString().padStart(2, '0')}:30`);
                            }
                        } else {
                            // 営業設定がない日曜・祝日は空き状況確認せずに終了
                            return;
                        }
                    }
                    
                    const reservedArr = await getReservationData();
                    let availableCount = 0;
                    
                    for (const t of times) {
                        const dt = `${dateStr}T${t}`;
                        const isReserved = reservedArr.some(r => r.datetime === dt);
                        const timeOverride = await checkScheduleOverride(dateStr, t);
                        
                        // 予約済みでなく、管理者が休業設定していない時間
                        if (!isReserved && timeOverride !== 'closed') {
                            availableCount++;
                        }
                    }
                    
                    if (availableCount === 0) {
                        dayElem.innerHTML += '<span style="color:red;font-size:1.2em;">×</span>';
                        dayElem.style.background = '#ffebee';
                        dayElem.style.pointerEvents = 'none';
                        dayElem.classList.add('flatpickr-disabled');
                    } else {
                        dayElem.innerHTML += '<span style="color:green;font-size:1.2em;">〇</span>';
                        dayElem.style.background = '#e8f5e8';
                        dayElem.style.pointerEvents = 'auto';
                        dayElem.classList.remove('flatpickr-disabled');
                        dayElem.removeAttribute('aria-disabled');
                        dayElem.setAttribute('tabindex', '0');
                    }
                }
            });

            // 管理者営業設定を確認して日曜日のカレンダー表示を更新
            setTimeout(async function() {
                console.log('日曜日営業設定確認開始');
                const today = new Date();
                
                for (let i = 0; i < 60; i++) { // 60日分チェック
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() + i);
                    const day = checkDate.getDay();
                    
                    if (day === 0) { // 日曜日のみチェック
                        const year = checkDate.getFullYear();
                        const month = String(checkDate.getMonth() + 1).padStart(2, '0');
                        const dateStr = `${year}-${month}-${String(checkDate.getDate()).padStart(2, '0')}`;
                        
                        console.log(`日曜日チェック: ${dateStr}`);
                        
                        try {
                            const dayOverride = await checkScheduleOverride(dateStr);
                            console.log(`設定確認結果: ${dateStr} -> ${dayOverride}`);
                            
                            if (dayOverride === 'open') {
                                console.log(`営業設定発見: ${dateStr} -> flatpickr更新開始`);
                                
                                // flatpickrの無効化を解除
                                if (window.calendar) {
                                    // 現在の無効化設定を取得
                                    const currentDisable = window.calendar.config.disable || [];
                                    
                                    // 日曜日以外の無効化条件を保持
                                    const newDisable = currentDisable.filter(disableRule => {
                                        if (typeof disableRule === 'function') {
                                            // 日曜日無効化関数以外は保持
                                            const testDate = new Date(checkDate);
                                            const isThisSunday = disableRule(testDate) && testDate.getDay() === 0;
                                            return !isThisSunday;
                                        }
                                        return true;
                                    });
                                    
                                    // 特定の日曜日を有効化
                                    const enableDates = window.calendar.config.enable || [];
                                    enableDates.push(new Date(checkDate));
                                    
                                    window.calendar.set('enable', enableDates);
                                    window.calendar.redraw();
                                    console.log(`flatpickr設定更新完了: ${dateStr}`);
                                }
                            }
                        } catch (error) {
                            console.error(`日曜日営業設定確認エラー (${dateStr}):`, error);
                        }
                    }
                }
            }, 1500); // カレンダー初期化を確実に待つ

            // 日付選択時、曜日ごとに時間帯を表示（日本語化も維持）
            document.getElementById('date').addEventListener('change', async function() {
                const dateStr = this.value;
                selectedDateValue = dateStr;
                selectedCourseValue = '';
                latestTimeSlots = [];
                setSubmitDisabled('時間を選択してください');
                updateBookingStepsState({ date: true, course: false, time: false });

                if (!dateStr) {
                    renderCourseSelect('まず予約日を選択してください');
                    resetTimeSelect('まず日付とコースを選択してください');
                    return;
                }

                const dateObj = new Date(`${dateStr}T00:00:00`);
                if (isPastDate(dateObj)) {
                    renderCourseSelect('過去の日付は選択できません');
                    resetTimeSelect('過去の日付は選択できません');
                    setSubmitDisabled('過去の日付は選択できません');
                    this.value = '';
                    selectedDateValue = '';
                    latestTimeSlots = [];
                    updateBookingStepsState({ date: true, course: false, time: false });
                    return;
                }

                renderCourseSelect('空き状況を確認しています...');
                resetTimeSelect('空き状況を確認しています');
                setDateInputLoading(true, '空き状況を確認しています...');

                try {
                    const slotResult = await buildBaseTimeSlots(dateStr);
                    latestTimeSlots = slotResult.slots || [];

                    if (slotResult.status === 'closed') {
                        const msg = slotResult.message || '休業日です';
                        renderCourseSelect(msg);
                        resetTimeSelect(msg);
                        setSubmitDisabled(msg);
                        updateBookingStepsState({ date: true, course: false, time: false });
                        return;
                    }

                    if (slotResult.status === 'full') {
                        renderCourseSelect('全て予約済みです');
                        resetTimeSelect('全て予約済みです');
                        setSubmitDisabled('全て予約済みです');
                        updateBookingStepsState({ date: true, course: false, time: false });
                        return;
                    }

                    renderCourseSelect();
                    resetTimeSelect('コースを選択してください');
                    updateBookingStepsState({ date: false, course: true, time: false });
                } catch (error) {
                    console.error('時間枠取得エラー:', error);
                    renderCourseSelect('空き状況の取得に失敗しました');
                    resetTimeSelect('空き状況の取得に失敗しました');
                    setSubmitDisabled('空き状況の取得に失敗しました');
                    updateBookingStepsState({ date: true, course: false, time: false });
                } finally {
                    setDateInputLoading(false);
                }
            });

            if (courseSelectElement) {
                courseSelectElement.addEventListener('change', function() {
                    selectedCourseValue = this.value;
                    if (!selectedDateValue) {
                        renderCourseSelect('まず予約日を選択してください');
                        resetTimeSelect('まず日付とコースを選択してください');
                        setSubmitDisabled('まず日付を選択してください');
                        updateBookingStepsState({ date: false, course: false, time: false });
                        return;
                    }

                    if (!selectedCourseValue) {
                        resetTimeSelect('コースを選択してください');
                        setSubmitDisabled('時間を選択してください');
                        updateBookingStepsState({ date: true, course: false, time: false });
                        return;
                    }

                    const filteredSlots = filterSlotsByCourse(latestTimeSlots, selectedCourseValue);
                    if (!filteredSlots.length) {
                        resetTimeSelect('選択したコースで予約可能な時間がありません');
                        setSubmitDisabled('別の時間帯をご検討ください');
                        updateBookingStepsState({ date: true, course: true, time: false });
                        return;
                    }
                    populateTimeSelect(filteredSlots);
                    setSubmitDisabled('時間を選択してください');
                    updateBookingStepsState({ date: true, course: true, time: false });
                });
            }


            // 予約済み時間を取得し、選択不可にする
            async function updateDisabledTimes() {
                await getReservationData(true);
                // 予約済み時間の取得のみ（UI反映はdate/timeのchangeイベントで実施）
            }
            

            /* セキュリティ上の理由によりEmailJS設定をコメントアウト
            // EmailJS初期化（新しいAPI Key使用）
            const emailJSConfig = {
                publicKey: 'Bjgie8FTLGEHn3yFv',
                serviceId: 'service_fsef42p',
                templateId: 'template_4w72csd'
            };
            
            console.log('📧 EmailJS設定:', emailJSConfig);
            
            try {
                emailjs.init(emailJSConfig.publicKey);
                window.AppLogger.info('EmailJS初期化完了 - API Key:', emailJSConfig.publicKey);
                window.emailJSEnabled = true;
                console.log('✅ EmailJS初期化成功');
            } catch (error) {
                window.AppLogger.error('EmailJS初期化エラー:', error);
                window.emailJSEnabled = false;
                console.error('❌ EmailJS初期化失敗:', error);
            }
            */

            // 予約フォーム送信
            document.getElementById('reserveForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const course = document.getElementById('course').value;
                const isNewCustomer = document.getElementById('is_new_customer').value === 'true';
                const referralSource = document.getElementById('referral_source').value;
                const datetime = `${date}T${time}`;
                // 排他制御: 予約済みと休業時間のチェック
                const [existingReservations, scheduleResult] = await Promise.all([
                    fetchReservationsByDateTime(datetime),
                    checkScheduleOverride(date, time)
                ]);
                
                // 1. 予約済みチェック
                if (existingReservations && existingReservations.length > 0) {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> その時間はすでに予約が入っています。別の時間を選択してください。';
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#dc3545';
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    return;
                }
                
                // 2. 休業時間チェック
                if (scheduleResult === 'closed') {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> 選択された時間は管理者により休業時間に設定されています。別の時間を選択してください。';
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#dc3545';
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    return;
                }
                // 予約登録
                console.log('予約データ送信開始:', { name, phone, datetime, course, email, isNewCustomer, referralSource });
                console.log('使用テーブル:', tableName);
                console.log('Supabaseクライアント:', !!window.supabase);
                
                const { data, error, source } = await insertReservationRecord({ 
                    name, 
                    phone, 
                    datetime, 
                    course, 
                    email,
                    is_new_customer: isNewCustomer,
                    referral_source: referralSource
                });
                
                console.log('予約登録結果:', { data, error, source });
                
                if (error) {
                    console.error('❌ 予約登録エラー詳細:', error);
                    const resultDiv = document.getElementById('result');
                    const isNetworkError = typeof error.message === 'string' && error.message.toLowerCase().includes('failed to fetch');
                    if (isNetworkError) {
                        resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> 予約データベースに接続できませんでした。<br><small>ネットワーク環境と Supabase の設定（CONFIGURATION_SETUP.md 参照）をご確認ください。</small>`;
                    } else {
                        resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> 予約登録に失敗しました。<br><small>エラー: ${error.message}</small>`;
                    }
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#dc3545';
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    return;
                }
                
                console.log('✅ 予約登録成功:', data);
                const savedRecord = Array.isArray(data) ? data[0] : (data || {});
                const reservationSyncPayload = {
                    id: savedRecord?.id || `local-${Date.now()}`,
                    name,
                    phone,
                    email,
                    course,
                    datetime,
                    durationMinutes: getCourseDuration(course),
                    is_new_customer: isNewCustomer,
                    referral_source: referralSource
                };
                syncCalendarReservation('create', reservationSyncPayload);

                // EmailJSでGmail通知（お店・本人両方に送信）
                console.log('メール送信開始:', { name, phone, datetime, course, email });

                const resultDiv = document.getElementById('result');
                const resetAndRefreshUI = async () => {
                    document.getElementById('reserveForm').reset();
                    selectedDateValue = '';
                    selectedCourseValue = '';
                    latestTimeSlots = [];
                    renderCourseSelect('まず予約日を選択してください');
                    resetTimeSelect('まず日付とコースを選択してください');
                    updateBookingStepsState({ date: true, course: false, time: false });
                    setSubmitDisabled('まず日付と時間を選択してください');
                    if (typeof renderReservations === 'function') {
                        try {
                            await renderReservations();
                        } catch (renderError) {
                            console.warn('予約一覧の再描画に失敗しました:', renderError);
                        }
                    }
                    await getReservationData(true);
                };

                // 予約日時を分かりやすくフォーマット
                const formatReservationDateTime = (dateStr, timeStr) => {
                    const dt = new Date(`${dateStr}T${timeStr}`);
                    const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                    const dayName = dayNames[dt.getDay()];
                    const month = dt.getMonth() + 1;
                    const day = dt.getDate();
                    const hour = dt.getHours();
                    const minute = String(dt.getMinutes()).padStart(2, '0');
                    return `${month}月${day}日(${dayName}) ${hour}:${minute}`;
                };
                const formattedDateTime = formatReservationDateTime(date, time);

                if (!window.emailJSEnabled) {
                    console.warn('⚠️ EmailJSが無効のため、メール送信をスキップします');
                    resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> ご予約を受け付けました。（メール通知は現在停止中です）<br><strong style="font-size: 16px; color: #1a237e;">予約日時: ${formattedDateTime}</strong><br><strong style="color: #1a237e;">コース: ${course}</strong><br><small>万一確認メールが届かない場合は ${contactPhone} までお電話ください。</small>`;
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#28a745';
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.borderColor = '#c3e6cb';
                    await resetAndRefreshUI();
                    return;
                }

                const templateParams = {
                    name,
                    phone,
                    datetime: datetime.replace('T', ' '),
                    course,
                    to_email: clinicEmail,
                    user_email: email,
                    message: `新しい予約が入りました。\n\n【予約内容】\nお名前: ${name}\n電話番号: ${phone}\n予約日時: ${datetime.replace('T', ' ')}\nコース: ${course}\nメール: ${email}`
                };

                try {
                    const emailResponse = await emailjs.send(
                        emailJSConfig.serviceId,
                        emailJSConfig.templateId,
                        templateParams
                    );
                    console.log('メール送信成功:', emailResponse);
                    resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> ご予約を受け付けました。ありがとうございます！<br><strong style="font-size: 16px; color: #1a237e;">予約日時: ${formattedDateTime}</strong><br><strong style="color: #1a237e;">コース: ${course}</strong><br><small>万一確認メールが届かない場合は ${contactPhone} までお電話ください。</small>`;
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#28a745';
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.borderColor = '#c3e6cb';
                } catch (emailError) {
                    console.error('メール送信エラー:', emailError);
                    resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ご予約は完了しましたが、メール通知に失敗しました。<br><small>エラー: ${emailError.text || emailError.message || '不明なエラー'}</small><br><small>Service ID: ${emailJSConfig.serviceId}</small><br><small>Template ID: ${emailJSConfig.templateId}</small><br><small>EmailJSダッシュボードで設定を確認してください: <a href=\"https://dashboard.emailjs.com/admin\" target=\"_blank\">https://dashboard.emailjs.com/admin</a></small><br><small>お急ぎの場合やメールが届かない場合は ${contactPhone} までお電話ください。</small>`;
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#856404';
                    resultDiv.style.background = '#fff3cd';
                    resultDiv.style.borderColor = '#ffeaa7';
                } finally {
                    await resetAndRefreshUI();
                }
            });
            
            if (timeSelectElement) {
                timeSelectElement.addEventListener('change', function() {
                    if (this.value && selectedCourseValue) {
                        setSubmitEnabled();
                        updateBookingStepsState({ date: true, course: true, time: true });
                    } else {
                        setSubmitDisabled('時間を選択してください');
                        updateBookingStepsState({ date: !!selectedDateValue, course: !!selectedCourseValue, time: false });
                    }
                });
            }


            // 初期表示
            try {
                await updateDisabledTimes();
            } catch (error) {
                console.error('予約データ初期化エラー:', error);
            }
            setDateInputLoading(false);

            // 初期状態でコースと送信ボタンを無効化
            renderCourseSelect('まず予約日を選択してください');
            resetTimeSelect('まず日付とコースを選択してください');
            setSubmitDisabled('まず日付と時間を選択してください');
        }
    </script>


</body>
</html>
